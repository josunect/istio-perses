apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  labels:
    app.kubernetes.io/name: perses-dashboard
    app.kubernetes.io/instance: 12c58766acc81a1c835dd5059eaf2741
    app.kubernetes.io/part-of: perses-operator
  name: 12c58766acc81a1c835dd5059eaf2741
  namespace: istio
spec:
  display:
    name: Istio Ztunnel Dashboard
  panels:
    0_0:
      kind: Panel
      spec:
        display:
          name: Ztunnel Versions
          description: Version number of each running instance
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
                - last
                - max
            visual:
              areaOpacity: 0.1
              connectNulls: false
              display: line
              lineWidth: 1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (tag) (istio_build{component="ztunnel"})
                  seriesNameFormat: Version ({{tag}})
    0_1:
      kind: Panel
      spec:
        display:
          name: Memory Usage
          description: Memory usage of each running instance
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
                - last
                - max
            visual:
              areaOpacity: 0.1
              connectNulls: false
              display: line
              lineWidth: 1
            yAxis:
              format:
                unit: bytes
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (pod)
                    (container_memory_working_set_bytes{container="istio-proxy",pod=~"ztunnel-.*"})
                  seriesNameFormat: Container ({{pod}})
    0_2:
      kind: Panel
      spec:
        display:
          name: CPU Usage
          description: CPU usage of each running instance
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
                - last
                - max
            visual:
              areaOpacity: 0.1
              connectNulls: false
              display: line
              lineWidth: 1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (pod)
                    (irate(container_cpu_usage_seconds_total{container="istio-proxy",pod=~"ztunnel-.*"}[$__rate_interval]))
                  seriesNameFormat: Container ({{pod}})
    1_0:
      kind: Panel
      spec:
        display:
          name: Connections
          description: Connections opened and closed per instance
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
                - last
                - max
            visual:
              areaOpacity: 0.1
              connectNulls: false
              display: line
              lineWidth: 1
            yAxis:
              format:
                unit: counts/sec
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (pod)
                    (rate(istio_tcp_connections_opened_total{pod=~"ztunnel-.*"}[$__rate_interval]))
                  seriesNameFormat: Opened ({{pod}})
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: -sum by (pod)
                    (rate(istio_tcp_connections_closed_total{pod=~"ztunnel-.*"}[$__rate_interval]))
                  seriesNameFormat: Closed ({{pod}})
    1_1:
      kind: Panel
      spec:
        display:
          name: Bytes Transmitted
          description: Bytes sent and received per instance
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
                - last
                - max
            visual:
              areaOpacity: 0.1
              connectNulls: false
              display: line
              lineWidth: 1
            yAxis:
              format:
                unit: bytes/sec
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (pod)
                    (rate(istio_tcp_sent_bytes_total{pod=~"ztunnel-.*"}[$__rate_interval]))
                  seriesNameFormat: Sent ({{pod}})
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (pod)
                    (rate(istio_tcp_received_bytes_total{pod=~"ztunnel-.*"}[$__rate_interval]))
                  seriesNameFormat: Received ({{pod}})
    1_2:
      kind: Panel
      spec:
        display:
          name: DNS Request
          description: DNS queries received per instance
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
                - last
                - max
            visual:
              areaOpacity: 0.1
              connectNulls: false
              display: line
              lineWidth: 1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (pod)
                    (rate(istio_dns_requests_total{pod=~"ztunnel-.*"}[$__rate_interval]))
                  seriesNameFormat: Request ({{pod}})
    2_0:
      kind: Panel
      spec:
        display:
          name: XDS Connections
          description: |
            Count of XDS connection terminations.
            This will typically spike every 30min for each instance.
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
                - last
                - max
            visual:
              areaOpacity: 0.1
              connectNulls: false
              display: line
              lineWidth: 1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (pod)
                    (rate(istio_xds_connection_terminations_total{pod=~"ztunnel-.*"}[$__rate_interval]))
                  seriesNameFormat: XDS Connection Terminations ({{pod}})
    2_1:
      kind: Panel
      spec:
        display:
          name: XDS Pushes
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
              values: []
            visual:
              areaOpacity: 1
              connectNulls: false
              display: bar
              lineWidth: 1
              stack: all
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (url)
                    (irate(istio_xds_message_total{pod=~"ztunnel-.*"}[$__rate_interval]))
                  seriesNameFormat: "{{url}}"
    2_2:
      kind: Panel
      spec:
        display:
          name: Workload Manager
          description: |
            Count of active and pending proxies managed by each instance.
            Pending is expected to converge to zero.
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
              values:
                - last
                - max
            visual:
              areaOpacity: 0.1
              connectNulls: false
              display: line
              lineWidth: 1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (pod) (workload_manager_active_proxy_count{pod=~"ztunnel-.*"})
                  seriesNameFormat: Active Proxies ({{pod}})
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (pod) (workload_manager_pending_proxy_count{pod=~"ztunnel-.*"})
                  seriesNameFormat: Pending Proxies ({{pod}})
  layouts:
    - kind: Grid
      spec:
        display:
          title: Process
          collapse:
            open: true
        items:
          - x: 0
            y: 0
            width: 8
            height: 8
            content:
              $ref: "#/spec/panels/0_0"
          - x: 8
            y: 0
            width: 8
            height: 8
            content:
              $ref: "#/spec/panels/0_1"
          - x: 16
            y: 0
            width: 8
            height: 8
            content:
              $ref: "#/spec/panels/0_2"
    - kind: Grid
      spec:
        display:
          title: Network
          collapse:
            open: true
        items:
          - x: 0
            y: 0
            width: 8
            height: 8
            content:
              $ref: "#/spec/panels/1_0"
          - x: 8
            y: 0
            width: 8
            height: 8
            content:
              $ref: "#/spec/panels/1_1"
          - x: 16
            y: 0
            width: 8
            height: 8
            content:
              $ref: "#/spec/panels/1_2"
    - kind: Grid
      spec:
        display:
          title: Operations
          collapse:
            open: true
        items:
          - x: 0
            y: 0
            width: 8
            height: 8
            content:
              $ref: "#/spec/panels/2_0"
          - x: 8
            y: 0
            width: 8
            height: 8
            content:
              $ref: "#/spec/panels/2_1"
          - x: 16
            y: 0
            width: 8
            height: 8
            content:
              $ref: "#/spec/panels/2_2"
  variables:
    - kind: ListVariable
      spec:
        display:
          hidden: false
        defaultValue: PBFA97CFB590B2093
        allowAllValue: false
        allowMultiple: false
        plugin:
          kind: DatasourceVariable
          spec:
            datasourcePluginKind: prometheus
        name: datasource
  duration: 1h
  refreshInterval: 0s
