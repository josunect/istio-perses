apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  labels:
    app.kubernetes.io/name: perses-dashboard
    app.kubernetes.io/instance: 1a9a8ea49444aae205c7737573e894f9
    app.kubernetes.io/part-of: perses-operator
  name: 1a9a8ea49444aae205c7737573e894f9
  namespace: istio
spec:
  display:
    name: Istio Mesh Dashboard
  panels:
    0_0:
      kind: Panel
      spec:
        display:
          name: Traffic Volume
          description: Total requests in the cluster
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            metricLabel: ""
            sparkline: {}
            thresholds:
              steps:
                - color: green
                  value: 0
                - color: red
                  value: 80
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  query: round(sum
                    (rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval])),
                    0.01)
    0_1:
      kind: Panel
      spec:
        display:
          name: Success Rate
          description: Total success rate of requests in the cluster
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: percent-decimal
            metricLabel: ""
            sparkline: {}
            thresholds:
              steps:
                - color: green
                  value: 0
                - color: red
                  value: 80
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  query: sum
                    (rate(istio_requests_total{reporter=~"source|waypoint",response_code!~"5.."}[$__rate_interval]))
                    / sum
                    (rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval]))
    0_2:
      kind: Panel
      spec:
        display:
          name: 4xxs
          description: Total 4xx requests in in the cluster
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            metricLabel: ""
            sparkline: {}
            thresholds:
              steps:
                - color: green
                  value: 0
                - color: red
                  value: 80
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: round(sum
                    (rate(istio_requests_total{reporter=~"source|waypoint",response_code=~"4.."}[$__rate_interval])),
                    0.01)or vector(0)
    0_3:
      kind: Panel
      spec:
        display:
          name: 5xxs
          description: Total 5xx requests in in the cluster
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            metricLabel: ""
            sparkline: {}
            thresholds:
              steps:
                - color: green
                  value: 0
                - color: red
                  value: 80
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: round(sum
                    (rate(istio_requests_total{reporter=~"source|waypoint",response_code=~"5.."}[$__rate_interval])),
                    0.01)or vector(0)
    0_4:
      kind: Panel
      spec:
        display:
          name: HTTP/gRPC Workloads
          description: Request information for HTTP services
        plugin:
          kind: Table
          spec:
            columnSettings:
              - header: Requests
                name: "Value #requests"
              - header: P50 Latency
                name: "Value #p50"
              - header: P90 Latency
                name: "Value #p90"
              - header: P99 Latency
                name: "Value #p99"
              - header: Success Rate
                name: "Value #success"
              - header: Workload
                name: destination_workload_var
              - header: Service
                name: destination_service
              - name: destination_workload_namespace
              - name: destination_workload
              - name: timestamp
            density: compact
            transforms:
              - kind: MergeSeries
                spec: {}
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: label_join(sum by
                    (destination_workload,destination_workload_namespace,destination_service)
                    (rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval])),
                    "destination_workload_var", ".", "destination_workload",
                    "destination_workload_namespace")
                  seriesNameFormat: "{{ destination_workload}}.{{ destination_workload_namespace
                    }}"
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: label_join(histogram_quantile(0.5, sum by
                    (le,destination_workload,destination_workload_namespace)
                    (rate(istio_request_duration_milliseconds_bucket{reporter=~"source|waypoint"}[$__rate_interval]))),
                    "destination_workload_var", ".", "destination_workload",
                    "destination_workload_namespace")
                  seriesNameFormat: "{{ destination_workload}}.{{ destination_workload_namespace
                    }}"
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: label_join(histogram_quantile(0.9, sum by
                    (le,destination_workload,destination_workload_namespace)
                    (rate(istio_request_duration_milliseconds_bucket{reporter=~"source|waypoint"}[$__rate_interval]))),
                    "destination_workload_var", ".", "destination_workload",
                    "destination_workload_namespace")
                  seriesNameFormat: "{{ destination_workload}}.{{ destination_workload_namespace
                    }}"
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: label_join(histogram_quantile(0.99, sum by
                    (le,destination_workload,destination_workload_namespace)
                    (rate(istio_request_duration_milliseconds_bucket{reporter=~"source|waypoint"}[$__rate_interval]))),
                    "destination_workload_var", ".", "destination_workload",
                    "destination_workload_namespace")
                  seriesNameFormat: "{{ destination_workload}}.{{ destination_workload_namespace
                    }}"
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: label_join(sum by (destination_workload,destination_workload_namespace)
                    (rate(istio_requests_total{reporter=~"source|waypoint",response_code!~"5.."}[$__rate_interval]))/sum
                    by (destination_workload,destination_workload_namespace)
                    (rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval])),
                    "destination_workload_var", ".", "destination_workload",
                    "destination_workload_namespace")
                  seriesNameFormat: "{{ destination_workload}}.{{ destination_workload_namespace
                    }}"
    0_5:
      kind: Panel
      spec:
        display:
          name: TCP Workloads
          description: Bytes sent and recieived information for TCP services
        plugin:
          kind: Table
          spec:
            columnSettings:
              - header: Bytes Received
                name: "Value #recv"
              - header: Bytes Sent
                name: "Value #sent"
              - header: Workload
                name: destination_workload_var
              - header: Service
                name: destination_service
              - name: destination_workload_namespace
              - name: destination_workload
              - name: timestamp
            density: compact
            transforms:
              - kind: MergeSeries
                spec: {}
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: label_join(sum by
                    (destination_workload,destination_workload_namespace,destination_service)
                    (rate(istio_tcp_received_bytes_total{reporter=~"source|waypoint"}[$__rate_interval])),
                    "destination_workload_var", ".", "destination_workload",
                    "destination_workload_namespace")
                  seriesNameFormat: "{{ destination_workload}}.{{ destination_workload_namespace
                    }}"
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: label_join(sum by
                    (destination_workload,destination_workload_namespace,destination_service)
                    (rate(istio_tcp_sent_bytes_total{reporter=~"source|waypoint"}[$__rate_interval])),
                    "destination_workload_var", ".", "destination_workload",
                    "destination_workload_namespace")
                  seriesNameFormat: "{{ destination_workload}}.{{ destination_workload_namespace
                    }}"
    1_0:
      kind: Panel
      spec:
        display:
          name: Istio Component Versions
          description: Version number of each running instance
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: list
              position: bottom
              values: []
            visual:
              areaOpacity: 0.1
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (component,tag) (istio_build)
                  seriesNameFormat: "{{component}} ({{tag}})"
  layouts:
    - kind: Grid
      spec:
        display:
          title: Global Traffic
          collapse:
            open: true
        items:
          - x: 0
            y: 0
            width: 6
            height: 5
            content:
              $ref: "#/spec/panels/0_0"
          - x: 6
            y: 0
            width: 6
            height: 5
            content:
              $ref: "#/spec/panels/0_1"
          - x: 12
            y: 0
            width: 6
            height: 5
            content:
              $ref: "#/spec/panels/0_2"
          - x: 18
            y: 0
            width: 6
            height: 5
            content:
              $ref: "#/spec/panels/0_3"
          - x: 0
            y: 5
            width: 24
            height: 16
            content:
              $ref: "#/spec/panels/0_4"
          - x: 0
            y: 21
            width: 24
            height: 16
            content:
              $ref: "#/spec/panels/0_5"
    - kind: Grid
      spec:
        display:
          title: Istio Component Versions
          collapse:
            open: true
        items:
          - x: 0
            y: 0
            width: 24
            height: 8
            content:
              $ref: "#/spec/panels/1_0"
  variables:
    - kind: ListVariable
      spec:
        display:
          hidden: false
        defaultValue: PBFA97CFB590B2093
        allowAllValue: false
        allowMultiple: false
        plugin:
          kind: DatasourceVariable
          spec:
            datasourcePluginKind: prometheus
        name: datasource
  duration: 30m
  refreshInterval: 0s
  datasources: {}
